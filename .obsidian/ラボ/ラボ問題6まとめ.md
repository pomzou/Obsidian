# iBGP（Route Reflector含む）ラボまとめ

## 要件定義

**目的:** 同じAS内でiBGPを構築してfull-meshとRoute Reflectorを理解する。

**構成要件:**

- ルーター4台（R1〜R4）、全部AS100
- 全ルーターにLoopbackを設定
- LoopbackはOSPFで到達可能にする
- 全ピアリングはLoopbackアドレスで行う
- host1（192.168.10.1/24）はR1配下
- host2（192.168.40.1/24）はR4配下
- host1↔host2のpingが通ること

**IPアドレス設計:**

```
R1: Lo0=1.1.1.1/32, Eth0/1=192.168.10.254/24, Eth0/2=10.0.12.1/30
R2: Lo0=2.2.2.2/32, Eth0/1=10.0.12.2/30,      Eth0/2=10.0.23.1/30
R3: Lo0=3.3.3.3/32, Eth0/1=10.0.23.2/30,      Eth0/2=10.0.34.1/30
R4: Lo0=4.4.4.4/32, Eth0/1=192.168.40.254/24, Eth0/2=10.0.34.2/30
host1: 192.168.10.1/24, GW=192.168.10.254
host2: 192.168.40.1/24, GW=192.168.40.254
```

---

## iBGPとeBGPの違い

||eBGP|iBGP|
|---|---|---|
|用途|異なるAS間|同じAS内|
|neighbor設定|remote-as に**違う**AS番号|remote-as に**同じ**AS番号|
|next-hop|自動で変わる|変わらない（next-hop-selfが必要な場合あり）|
|TTL|1（直接繋がってる必要）|255（Loopback経由でも届く）|

---

## なぜiBGPを使うか

eBGPで受け取った大量の経路（インターネット全経路など）をAS内に配るため。OSPFは大量経路の処理に向いてないのでiBGPを使う。

```
外部AS → eBGP → R1 → iBGP → R2、R3、R4（AS内に経路を配布）
```

---

## iBGPのルール

**「iBGPで受け取った経路は別のiBGPピアに転送しない」**

理由: eBGPはAS-PATHでループを検知できるが、iBGPは同じAS内なのでAS-PATHが追加されずループが発生する可能性があるため。

---

## Loopbackでのピアリング

**なぜLoopbackを使うか:** 物理リンクが落ちても別経路があればiBGPセッションが維持できる。

**設定方法:**

```
neighbor 2.2.2.2 remote-as 100
neighbor 2.2.2.2 update-source Loopback0
```

**前提条件:** LoopbackのIPにOSPFで到達できること。

```
router ospf 1
 network 1.1.1.1 0.0.0.0 area 0  ← Loopbackを広報
 network 10.0.12.0 0.0.0.3 area 0
```

---

## full-mesh問題

iBGPのルール（受け取った経路を転送しない）のため、全ルーターが全ルーターと直接ピアリングする必要がある。

```
4台の場合: R1-R2、R1-R3、R1-R4、R2-R3、R2-R4、R3-R4 = 6ペア
10台の場合: 45ペア
100台の場合: 4950ペア
```

台数が増えると管理が現実的でなくなる。

---

## Route Reflector

full-mesh問題を解決する仕組み。1台をRoute Reflectorに指定すると、他のルーター（クライアント）はRoute Reflectorとだけピアリングすればいい。

**Route Reflectorが経路を反射するルール:**

- eBGPから受け取った経路 → 全クライアントに転送
- クライアントから受け取った経路 → 他の全クライアントとeBGPピアに転送
- 非クライアントから受け取った経路 → クライアントのみに転送

**ピアリング数の比較:**

```
full-mesh（4台）: 6ペア
Route Reflector（R2がRR）: R1-R2、R3-R2、R4-R2 = 3ペア
```

### Route Reflectorの設定

**Route Reflector（R2）側:**

```
router bgp 100
 neighbor 1.1.1.1 remote-as 100
 neighbor 1.1.1.1 update-source Loopback0
 neighbor 1.1.1.1 route-reflector-client
 neighbor 3.3.3.3 remote-as 100
 neighbor 3.3.3.3 update-source Loopback0
 neighbor 3.3.3.3 route-reflector-client
 neighbor 4.4.4.4 remote-as 100
 neighbor 4.4.4.4 update-source Loopback0
 neighbor 4.4.4.4 route-reflector-client
```

**クライアント（R1、R3、R4）側:**

```
router bgp 100
 neighbor 2.2.2.2 remote-as 100
 neighbor 2.2.2.2 update-source Loopback0
```

クライアント側はRoute Reflectorとだけピアリングすればいい。`route-reflector-client`の設定も不要。

---

## iBGP正常動作チェックリスト

- [ ] OSPFでLoopback間の経路が学習されてるか（show ip route）
- [ ] BGPネイバーがEstablished状態か（show ip bgp summary）
- [ ] BGPテーブルに全ネットワークが載ってるか（show ip bgp）
- [ ] ルーティングテーブルにB（BGP）の経路が入ってるか（show ip route）
- [ ] host1↔host2のpingが通るか

---

## 使用したコマンド

```
# BGPネイバーの状態確認
show ip bgp summary

# BGPテーブル確認
show ip bgp

# ルーティングテーブル確認
show ip route

# OSPF経路確認（Loopback到達性）
show ip route ospf
show ip ospf neighbor
```

---

## 今回のハマりポイント

### OSPFにLoopbackを入れないとiBGPが確立しない

Loopbackでピアリングするにはそのアドレスに到達できる必要がある。OSPFのnetworkコマンドにLoopbackのアドレスを忘れずに追加する。

```
network 1.1.1.1 0.0.0.0 area 0  ← ワイルドカード0.0.0.0で/32を指定
```

### ワイルドカードのタイポに注意

`0.0.0.0`と`20.0.0.0`は全く違う意味になる。目視確認を徹底する。

---

## 次のラボ

eBGP + iBGP 混合ラボ