# STP / RSTP (802.1D) ラボまとめ

## 要件定義

**目的:** STPが正常に動作する冗長ネットワークを構築する。

**構成要件:**

- スイッチ4台（sw1〜sw4）、ホスト2台（host1、host2）
- sw1を意図的にルートブリッジにする（Priority設定必須）
- ループが発生する冗長リンクを持つ構成
- host1（192.168.10.1/24）はsw2配下
- host2（192.168.10.2/24）はsw3配下
- 全ホスト間でpingが通ること

**構成図:**
![[Pasted image 20260213223441.png]]
---

## 基本概念

### STPとは何か

ループを防ぐプロトコル。スイッチを複数台繋ぐと冗長性が生まれるが、同時にループが発生するリスクがある。STPはループになる経路を1本ブロックすることでループを防ぐ。

**ブロードキャストストームとは:** ループがあるとブロードキャストフレームが永遠に増殖し続ける。これがブロードキャストストームでネットワーク全体が機能停止する。STPはこれを防ぐ。

---

### ルートブリッジの選出

STPはまず「センター」となるルートブリッジを1台選ぶ。全ての通信はこのルートブリッジを中心としたツリー構造の上を通る。

**選出ルール（優先順位順）:**

1. Bridge Priorityが一番小さいスイッチ
2. Priorityが同じなら**MACアドレスが一番小さい**スイッチ

**重要:** デフォルトPriorityは全スイッチ同じ（32768）なので、何も設定しないとMACアドレスで決まる。つまり意図しないスイッチがルートブリッジになる可能性がある。

**実務では必ずPriorityで明示的に指定する:**

```
spanning-tree vlan 1 priority 0
```

---

### ポートの役割

|ロール|説明|状態|
|---|---|---|
|Root Port|ルートブリッジへの最短経路ポート|FWD|
|Designated Port|セグメントへの最短経路ポート|FWD|
|Alternate Port|ループになる経路をブロックするポート|BLK|

**ポイント:**

- ルートブリッジ自身はRoot Portを持たない（自分がルートだから）
- ルートブリッジ以外のスイッチは必ず1つRoot Portを持つ
- BLKポートはデータを転送しないがBPDUは受信し続ける

---

### コスト（経路の選び方）

各スイッチはルートブリッジへの「コスト」が最小の経路をRoot Portとして選ぶ。

コストはリンク速度で決まる（速いリンク=低コスト）。今回のラボでは全リンク同じ速度なのでホップ数で考えればOK。

**例:**

```
sw3のルートブリッジ(sw1)へのコスト計算：
eth1経由 → sw1まで1hop → コスト100
eth2経由 → sw2経由でsw1まで2hop → コスト200

→ eth1がRoot Port（FWD）、eth2がBLK
```

---

## STPの状態遷移

STPのポートは以下の状態を経てForwardingになる：

```
Blocking → Listening → Learning → Forwarding
  (20秒)     (15秒)      (15秒)
```

合計約30〜50秒かかる。これがSTPの収束が遅い理由。RSTPはこれを1〜2秒に改善している。

---

## 今回のラボで確認したこと

### 1. sw1をルートブリッジに設定

startup-configでPriorityを0に設定：

```
spanning-tree vlan 1 priority 0
```

`show spanning-tree`でsw1がルートブリッジになってることを確認。

---

### 2. 正常時のSTP状態

sw4のEt0/3とEt0/1がBLKになっていることを確認。

ループになる経路：

- sw2-sw4間
- sw3-sw4間
- sw1-sw4間

STPがこのうち適切なポートをBLKにしてループを防いでいる。

---

### 3. フェールオーバーテスト

**テスト内容:** sw1のeth1（sw2への接続）をdownさせる

**Before:**

- sw4のeth1: BLK
- sw4のeth3: FWD（sw1へのRoot Port）

**After（sw1のeth1をdown）:**

- sw4のeth1: BLK → **FWD**に変化
- 迂回経路: sw2 → sw4 → sw1 → sw3

**結果:** pingが途切れることなく通信が継続した。STPが自動で再収束して迂回経路に切り替わった。

---

## STP正常動作チェックリスト

- [ ]  host1↔host2のpingが通るか
- [ ]  意図したスイッチがルートブリッジになってるか（`show spanning-tree`でRoot IDを確認）
- [ ]  ルートブリッジが1台だけか
- [ ]  ループになるリンクが1本以上BLKになってるか
- [ ]  ホスト向けポートがBLKになってないか
- [ ]  リンクを1本落としても通信が復旧するか（フェールオーバーテスト）

---

## 使用したコマンド

bash

```bash
# STPの状態確認（ルートブリッジ、ポートの役割と状態）
show spanning-tree

# 特定インターフェースの詳細確認
show interfaces Ethernet0/1

# インターフェースをdown/up
interface Ethernet0/1
 shutdown
 no shutdown
```

---

---

## STP vs RSTP 比較

### 収束速度の比較（実測）

|プロトコル|リンク障害からの復旧時間|
|---|---|
|STP (802.1D)|約32秒|
|RSTP (802.1W)|約1.8秒|

約17倍の差。

### なぜRSTPは速いか

**STPの状態遷移:**

```
Blocking → Listening（15秒）→ Learning（15秒）→ Forwarding
合計: 30〜50秒
```

**RSTPの状態遷移:**

```
Discarding → Learning → Forwarding
タイマーを使わず隣接スイッチとProposal/Agreementネゴシエーションで即座に遷移
合計: 1〜2秒
```

RSTPはタイマーを待たずに隣接スイッチと直接ネゴシエーションして状態をスキップする。

### RSTPの追加ポートタイプ

|ポート|説明|
|---|---|
|Edge Port (PortFast相当)|ホスト向けポート。即座にForwardingになる|
|Alternate Port|BLKの代替経路。障害時に即座にForwardingに切り替わる|

---

## 現代でのSTP系プロトコルの位置づけ

STP（802.1D）は2004年にRSTPに統合されて事実上廃止。

|プロトコル|使う場面|
|---|---|
|STP (802.1D)|レガシー環境のみ（古い工場、金融系レガシーシステム）|
|RSTP (802.1W)|中小規模のL2ネットワーク|
|Rapid PVST+|Cisco環境でVLAN多数|
|MSTP (802.1S)|大規模・マルチベンダー環境|
|EVPN-VXLAN|現代のデータセンター（STP不要）|

**重要:** RSTPはSTPとの後方互換性があるが、STPスイッチが混在するとそのポートだけSTPモードに戻る。これによりRSTPの速度メリットが失われる。

---

## Ciscoの設定コマンド

```
# STPモードの確認
show spanning-tree summary

# STPモードの変更
spanning-tree mode pvst          # STP
spanning-tree mode rapid-pvst    # RSTP

# ルートブリッジの指定
spanning-tree vlan 1 priority 0

# Edge Port（PortFast）の設定
interface Ethernet0/1
 spanning-tree portfast

# BPDU Guard（PortFastと一緒に使う）
interface Ethernet0/1
 spanning-tree bpduguard enable
```

---

## 次のラボ

EtherChannel / LACP