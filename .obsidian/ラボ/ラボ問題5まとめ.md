# BGP（eBGP基礎）ラボまとめ

## 要件定義

**目的:** 異なるAS間でeBGPピアリングを確立して通信できる環境を構築する。

**構成要件:**

- ルーター3台（R1、R2、R3）
- R1: AS100、R2: AS200、R3: AS300
- 各ルーターにLoopbackを設定
- host1（192.168.10.1/24）はR1配下
- host2（192.168.30.1/24）はR3配下
- host1↔host2のpingが通ること

**IPアドレス設計:**

```
R1: Lo0=1.1.1.1/32, Eth0/1=192.168.10.254/24, Eth0/2=10.0.12.1/30
R2: Lo0=2.2.2.2/32, Eth0/1=10.0.12.2/30,      Eth0/2=10.0.23.1/30
R3: Lo0=3.3.3.3/32, Eth0/1=192.168.30.254/24, Eth0/2=10.0.23.2/30
host1: 192.168.10.1/24, GW=192.168.10.254
host2: 192.168.30.1/24, GW=192.168.30.254
```

**構成図:**
![[Pasted image 20260215183828.png]]
---

## 基本概念

### BGPとは

インターネットそのものを動かしてるルーティングプロトコル。ISP（インターネットプロバイダ）間の経路交換に使われる。

**OSPFとの根本的な違い:**

||OSPF|BGP|
|---|---|---|
|用途|同じ組織内（社内ネットワーク）|異なる組織間（ISP同士）|
|隣接発見|自動（Hello）|手動でneighborを設定|
|経路広報|直接繋がってるネットワークを自動広報|networkコマンドで明示的に指定|
|収束速度|数秒〜数十秒|数分かかることがある|
|経路選択|コスト（帯域）|AS-PATH、ポリシーなど多数の属性|

### AS（Autonomous System）

BGPにおける「組織」の単位。ASには番号（AS番号）が割り当てられる。

```
AS100 = 会社Aのネットワーク
AS200 = ISPのネットワーク
AS300 = 会社Bのネットワーク
```

### eBGP vs iBGP

|種類|用途|
|---|---|
|eBGP（external BGP）|異なるAS間のピアリング|
|iBGP（internal BGP）|同じAS内のピアリング|

---

## 設定方法

### 基本設定

```
router bgp 100
 neighbor 10.0.12.2 remote-as 200
 network 192.168.10.0 mask 255.255.255.0
```

**OSPFのnetworkコマンドとの違い:**

- OSPFの`network`: 「このインターフェースをOSPFに参加させる」
- BGPの`network`: 「このネットワークをBGPで広報する」

**重要:** BGPで広報するネットワークはルーティングテーブルに存在してないといけない。直接繋がってるネットワークは問題なし。

### 中継ルーター（R2）の設定

中継ルーターはnetworkコマン不要。両側のネイバーを設定するだけ。受け取った経路を自動で転送する。

```
router bgp 200
 neighbor 10.0.12.1 remote-as 100
 neighbor 10.0.23.2 remote-as 300
```

---

## BGPの収束について

**重要な実務知識:**

BGPはOSPFより収束が遅い。起動直後は数分かかることがある。

```
OSPFの収束: 数秒〜数十秒
BGPの収束:  数分かかることがある
```

本番環境でBGPの設定変更をするときは「すぐ反映されない」ことを前提に作業する。

---

## BGP正常動作チェックリスト

- [ ] BGPネイバーがEstablished状態か（show ip bgp summary）
- [ ] BGPテーブルに経路が載ってるか（show ip bgp）
- [ ] ルーティングテーブルにB（BGP）の経路が入ってるか（show ip route）
- [ ] host1↔host2のpingが通るか

---

## 使用したコマンド

```
# BGPネイバーの状態確認（State/PfxRcdがEstablishedと受信経路数）
show ip bgp summary

# BGPテーブル確認（学習した全経路、AS-PATH確認）
show ip bgp

# 特定経路の詳細確認
show ip route 192.168.30.0

# ルーティングテーブル全体
show ip route
```

### BGPテーブルの読み方

```
Network          Next Hop     Path
192.168.10.0     0.0.0.0      i          ← 自分のネットワーク
192.168.30.0     10.0.12.2    200 300 i  ← AS200経由でAS300から学習
```

- `*>`: valid かつ best path
- `Path`: 経由したASの番号（AS-PATH）
- `0.0.0.0`: 自分が直接持ってるネットワーク

---

## 今回のハマりポイント

### BGPの収束待ち

設定は正しくてもpingが通らないことがある。BGPは収束に時間がかかるため、起動後数分待つ必要がある。すぐに「設定が間違ってる」と判断しないこと。

### BGPのnetworkコマンドはホストネットワークを広報する

ルーター間リンク（10.0.x.x）ではなくホストが繋がってるネットワーク（192.168.x.x）を広報する。

---

## 次のラボ

iBGP または BGPの経路制御（フィルタリング）