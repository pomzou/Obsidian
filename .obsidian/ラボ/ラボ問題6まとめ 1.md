# eBGP + iBGP 混合ラボまとめ

## 要件定義

**目的:** eBGPとiBGPを組み合わせた実務に近い構成を構築する。

**構成要件:**

- ルーター5台（R1〜R5）
- AS100（社内）: R1、R2、R3（R2がRoute Reflector）
- AS200（上位ISP）: R4
- AS300（外部）: R5
- AS100内はiBGP + Route Reflector + OSPF
- AS間はeBGP（物理IPで直接ピアリング）
- host1（192.168.10.1/24）はR1配下
- host2（192.168.40.1/24）はR5配下

**IPアドレス設計:**

```
R1: Lo0=1.1.1.1/32, Eth0/1=192.168.10.254/24, Eth0/2=10.0.12.1/30
R2: Lo0=2.2.2.2/32, Eth0/1=10.0.12.2/30,      Eth0/2=10.0.23.1/30
R3: Lo0=3.3.3.3/32, Eth0/1=10.0.23.2/30,      Eth0/2=10.0.34.1/30
R4: Lo0=4.4.4.4/32, Eth0/1=10.0.34.2/30,      Eth0/2=10.0.45.1/30
R5: Lo0=5.5.5.5/32, Eth0/1=192.168.40.254/24, Eth0/2=10.0.45.2/30
```

**構成図:**

```
host1 -- R1(AS100) -- R2(AS100/RR) -- R3(AS100) -- R4(AS200) -- R5(AS300) -- host2
          iBGP Lo0      iBGP Lo0         iBGP Lo0      eBGP          eBGP
          OSPF          OSPF             OSPF
```

---

## 設定のポイント

### AS100内（iBGP + OSPF）

**OSPFでLoopback到達性を確保してからiBGPでLoopbackピアリング。**

```
router ospf 1
 network 1.1.1.1 0.0.0.0 area 0   ← Loopbackを広報
 network 10.0.12.0 0.0.0.3 area 0

router bgp 100
 neighbor 2.2.2.2 remote-as 100          ← 同じAS番号 = iBGP
 neighbor 2.2.2.2 update-source Loopback0
 network 192.168.10.0 mask 255.255.255.0
```

### AS間（eBGP）

**物理IPで直接ピアリング。update-source不要。**

```
# R3（AS100）
router bgp 100
 neighbor 10.0.34.2 remote-as 200   ← 違うAS番号 = eBGP

# R4（AS200）
router bgp 200
 neighbor 10.0.34.1 remote-as 100
 neighbor 10.0.45.2 remote-as 300
```

---

## eBGP Loopbackピアリング

### なぜLoopbackでピアリングするか

物理IPでピアリングするとそのインターフェースが落ちたらBGPセッションが切れる。Loopbackでピアリングすると別経路があればセッションが維持される。

### TTLの問題

eBGPはデフォルトTTL=1。物理IPで直接繋がってるインターフェースとしかピアリングできない。Loopbackに到達するにはTTLを2以上にする必要がある。

```
neighbor 4.4.4.4 ebgp-multihop 2
```

### Loopbackへの到達性

LoopbackIPにパケットが届く経路が必要。方法は2つ：

**スタティックルート（シンプルな構成）:**

```
ip route 4.4.4.4 255.255.255.255 10.0.34.2
```

**OSPF（リンクが多い場合）:** R3とR4の間でOSPFを動かしてLoopback経路を自動学習。スタティック不要。

### 冗長構成でのLoopbackピアリング

```
R3 --[eth0/2]--> R4
R3 --[eth0/3]--> R4  ← 2本目のリンク
```

この場合、2本のスタティックルートを設定：

```
ip route 4.4.4.4 255.255.255.255 10.0.34.2   ← eth0/2経由
ip route 4.4.4.4 255.255.255.255 10.0.X.2    ← eth0/3経由
```

片方が落ちても別経路でLoopbackに到達できてBGPセッションが維持される。

### eBGP Loopbackピアリングの完全な設定

```
# R3側
neighbor 4.4.4.4 remote-as 200
neighbor 4.4.4.4 update-source Loopback0
neighbor 4.4.4.4 ebgp-multihop 2
ip route 4.4.4.4 255.255.255.255 10.0.34.2

# R4側
neighbor 3.3.3.3 remote-as 100
neighbor 3.3.3.3 update-source Loopback0
neighbor 3.3.3.3 ebgp-multihop 2
ip route 3.3.3.3 255.255.255.255 10.0.34.1
```

---

## iBGPとeBGPの設定比較

|項目|iBGP|eBGP|
|---|---|---|
|remote-as|自分と同じAS番号|相手の違うAS番号|
|ピアリングアドレス|Loopback推奨|物理IP（基本）またはLoopback|
|update-source|Loopback0|物理IPなら不要|
|ebgp-multihop|不要|Loopbackピアリング時に必要|
|TTLデフォルト|255|1|
|経路転送|受け取った経路を転送しない|AS-PATHでループ防止して転送|

---

## BGP正常動作チェックリスト

- [ ] OSPFネイバーがFULL状態か（AS100内のみ）
- [ ] BGPネイバーがEstablished状態か（show ip bgp summary）
- [ ] BGPテーブルに全ネットワークが載ってるか（show ip bgp）
- [ ] AS-PATHが正しいか（show ip bgp で確認）
- [ ] ルーティングテーブルにB（BGP）の経路が入ってるか
- [ ] host1↔host2のpingが通るか

---

## AS-PATHの読み方

```
Network          Next Hop    Path
192.168.40.0     10.0.12.2   200 300 i
```

- `200 300`: AS200経由でAS300から学習した経路
- 右から左に読む: AS300が起点、AS200を経由してきた
- ループ防止: 自分のAS番号があったら拒否する

---

## 次のラボ

EtherChannel / LACP