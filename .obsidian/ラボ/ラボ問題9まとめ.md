# VLAN + EtherChannel（LACP）ラボまとめ

## 要件定義

**目的:** 複数VLANとLACPを組み合わせた構成を構築する。

**構成要件:**

- スイッチ2台（sw1、sw2）
- sw1-sw2間を2本のリンクでEtherChannel（LACP）
- EtherChannelはtrunkモード
- VLAN10: host1（192.168.10.1/24）はsw1配下、host3（192.168.10.3/24）はsw2配下
- VLAN20: host2（192.168.20.1/24）はsw1配下、host4（192.168.20.2/24）はsw2配下
- 同じVLAN間でpingが通ること
- 異なるVLAN間はpingが通らないこと

**構成図:**

![[Pasted image 20260219004411.png]] 

---

## 設定のポイント

### トランクモードのEtherChannel

複数VLANを通すスイッチ間リンクはtrunkモードにする必要がある。

**重要:** Cisco IOLでは`switchport trunk encapsulation dot1q`の設定が必須。

```
interface port-channel 1
 switchport trunk encapsulation dot1q  ← IOLで必須
 switchport trunk allowed vlan 10,20
 switchport mode trunk
!
interface range Ethernet1/1 - 2
 channel-group 1 mode active
```

### 設定順序の重要性

1. Port-channelにtrunk設定を先に入れる
2. その後、物理インターフェースにchannel-groupを設定する

この順番でないとPort-channelがtrunkモードにならない場合がある。

---

## ContainerLabでのインターフェースマッピング

Cisco IOL L2でのインターフェース名とContainerLabのendpointsの対応：

```
Ethernet0/0 → eth0（管理用）
Ethernet0/1 → eth1
Ethernet0/2 → eth2
Ethernet0/3 → eth3
Ethernet1/0 → eth4
Ethernet1/1 → eth5
Ethernet1/2 → eth6
```

yamlのlinksでは`eth5`、`eth6`と書く。

---

## 今回のハマりポイント

### trunk encapsulation dot1qの設定が必須

Cisco IOLでは`switchport mode trunk`を設定する前に、トランクのカプセル化タイプを明示的に指定する必要がある。

**エラーメッセージ:**

```
Command rejected: An interface whose trunk encapsulation is "Auto" can not be configured to "trunk" mode.
```

**解決策:**

```
switchport trunk encapsulation dot1q
switchport mode trunk
```

この1行が抜けるとPort-channelがtrunkモードにならず、VLAN1（access mode）のままになる。

### startup-configの反映確認

startup-configに書いても反映されない場合がある。`show running-config interface`で必ず確認する。

---

## 検証結果

**同じVLAN間の通信:**

- host1(VLAN10) → host3(VLAN10): ping通る ✓
- host2(VLAN20) → host4(VLAN20): ping通る ✓

**異なるVLAN間の通信:**

- host1(VLAN10) → host2(VLAN20): ping通らない ✓
- host1(VLAN10) → host4(VLAN20): ping通らない ✓

VLANによる分離が正常に機能している。

---

## VLAN + EtherChannel正常動作チェックリスト

- [ ] Port-channelがtrunkモードか（show vlan brief でPo1がリストに出ないこと）
- [ ] Port-channelが`SU`状態か（show etherchannel summary）
- [ ] 全ポートが`P`状態か（show etherchannel summary）
- [ ] 各VLANに正しいポートが割り当てられてるか（show vlan brief）
- [ ] 同じVLAN間でpingが通るか
- [ ] 異なるVLAN間でpingが通らないか

---

## 使用したコマンド

```
# EtherChannelの状態確認
show etherchannel summary

# VLAN割り当て確認（trunkポートはリストに出ない）
show vlan brief

# Port-channelのswitchport設定確認
show interfaces Port-channel1 switchport

# 個別インターフェースの設定確認
show running-config interface Ethernet1/1
```

---

## 実務での使い方

|用途|構成|
|---|---|
|アクセススイッチ ↔ ディストリビューションスイッチ|LACP trunk（複数VLAN）|
|サーバー ↔ スイッチ|通常は単一VLAN、冗長性目的でLACP|
|データセンターのスイッチ間|LACP trunk + 大量VLAN|

---

## 次のラボ

MSTP（Multiple Spanning Tree Protocol）