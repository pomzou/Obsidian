# OSPF Single Area ラボまとめ

## 要件定義

**目的:** OSPF Single Areaが正常に動作するネットワークを構築する。

**構成要件:**

- ルーター4台（R1〜R4）、ホスト2台（host1、host2）
- 全ルーターがOSPF Area 0に参加
- host1（192.168.10.1/24）はR1配下、GW=192.168.10.254
- host2（192.168.20.1/24）はR4配下、GW=192.168.20.254
- host1↔host2間でpingが通ること

**IPアドレス設計:**

```
R1: Eth0/1=192.168.10.254/24, Eth0/2=10.0.12.1/30
R2: Eth0/1=10.0.12.2/30,      Eth0/2=10.0.23.1/30
R3: Eth0/1=10.0.23.2/30,      Eth0/2=10.0.34.1/30
R4: Eth0/1=192.168.20.254/24, Eth0/2=10.0.34.2/30
host1: 192.168.10.1/24, GW=192.168.10.254
host2: 192.168.20.1/24, GW=192.168.20.254
```

**構成図:**

```
host1 -- R1 -- R2 -- R3 -- R4 -- host2
     192.168.10.0  10.0.x.x      192.168.20.0
```

---

## 基本概念

### OSPFとは

動的ルーティングプロトコル。ルーター同士がネイバー関係を結び、ネットワーク情報を交換して自動でルーティングテーブルを作る。

**スタティックルートとの違い:**

- スタティック: 管理者が手動で経路を書く
- OSPF: ルーター同士が自動で経路を学習する

### プロセスID

```
router ospf 1
```

OSPFプロセスの識別子。複数のOSPFプロセスを動かす場合に使い分ける。番号は何でもいいが慣例的に1を使う。

### Area

OSPFはエリアという単位でネットワークを分割する。今回はSingle Areaなので全ルーターがArea 0（バックボーンエリア）に所属する。

### networkコマンド

```
network 10.0.12.0 0.0.0.3 area 0
```

「このアドレス範囲に含まれるインターフェースをOSPF Area 0に参加させる」という意味。

**ワイルドカードマスク:** サブネットマスクの逆数。`255 - サブネットマスク`で計算する。

よく使うもの:

- /30 → 0.0.0.3
- /24 → 0.0.0.255
- /16 → 0.255.255.255

### Loopbackアドレス（実務では必須）

物理インターフェースと違って絶対にdownしない仮想インターフェース。OSPFのRouter IDとして使われる。物理リンクが落ちてもRouter IDが変わらないから安定する。

```
interface Loopback0
 ip address 1.1.1.1 255.255.255.255
```

### デフォルトゲートウェイ

ホストはOSPFに参加しない。「どこに送ればいいかわからないパケットは全部ルーターに投げる」という設定が必要。

bash

```bash
# Linuxホストでのデフォルトゲートウェイ設定
ip route add default via 192.168.10.254
```

**重要:** ContainerLabではホストに管理ネットワーク（172.20.20.0/24）のデフォルトルートが自動で入る。上書きが必要。

yaml

```yaml
exec:
  - ip addr add 192.168.10.1/24 dev eth1
  - ip link set eth1 up
  - ip route del default
  - ip route add default via 192.168.10.254
```

---

## Cisco IOL startup-config の書き方

yaml

```yaml
startup-config: |
  interface Ethernet0/1
   ip address 192.168.10.254 255.255.255.0
   no shutdown
  !
  interface Ethernet0/2
   ip address 10.0.12.1 255.255.255.252
   no shutdown
  !
  router ospf 1
   network 10.0.12.0 0.0.0.3 area 0
   network 192.168.10.0 0.0.0.255 area 0
  !
```

**注意点:**

- `conf t`は不要
- インデントは1スペース
- `area 0`はスペースが必要（`area0`はNG）
- `ip add`より`ip address`の方が確実

---

## トラブルシューティングフロー

**pingが通らないときの確認順序（ボトムアップ）:**

```
L0: yamlのendpointsが正しいか（リンクの繋ぎ間違い）
  ↓
L1: リンクがupか
    show interfaces brief
  ↓
L2: 設定が正しく入ってるか
    show running-config
  ↓
L3-a: IPアドレスが正しいか
      show ip interface brief
  ↓
L3-b: OSPFネイバーが確立されてるか
      show ip ospf neighbor
  ↓
L3-c: ルーティングテーブルが正しいか
      show ip route
  ↓
L3-d: エンドホスト側のIPとデフォルトGWが正しいか
      ip addr show
      ip route show
```

**重要:** ルーター側が全部正常なのにpingが通らない場合は必ずホスト側を疑う。

---

## 使用したコマンド

```
# OSPFの状態確認
show ip ospf
show ip ospf neighbor
show ip ospf interface

# ルーティングテーブル確認
show ip route
show ip route ospf

# インターフェース確認
show interfaces brief
show ip interface brief

# ホスト側確認（Linux）
ip addr show
ip route show
ping 192.168.20.1
```

---

## 今回のハマりポイント

**ContainerLabのデフォルトゲートウェイ問題:**

ContainerLabはホストに管理ネットワーク（172.20.20.0/24）のデフォルトルートを自動で設定する。execで`ip route add default`を追加しても、後から管理ネットワークのルートで上書きされる場合がある。

**解決策:** `ip route del default`で既存のデフォルトルートを削除してから設定する。

---

## OSPF正常動作チェックリスト

- [ ]  全インターフェースがupか（show interfaces brief）
- [ ]  OSPFネイバーがFULL状態か（show ip ospf neighbor）
- [ ]  全ネットワークがルーティングテーブルに載ってるか（show ip route）
- [ ]  エンドホストのIPとデフォルトGWが正しいか
- [ ]  host1↔host2のpingが通るか

---

## 次のラボ

OSPF Multi Area