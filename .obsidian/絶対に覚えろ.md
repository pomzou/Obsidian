まず障害の切り分け方　忘れないようにメモ


## 基本原則

**ボトムアップで確認する。物理層から始めてアプリケーション層に向かう。** **仮説を立ててから確認する。闇雲にコマンドを打たない。** **1箇所確認したら結果を解釈してから次に進む。**

---

## Step 0: 症状を整理する

確認する前にまず頭の中を整理する。

- **何が起きてるか:** pingが通らない、通信が遅い、特定のホストだけ繋がらない
- **どこからどこへ:** host1からhost2、R1からR4など
- **いつから:** 設定変更後、ケーブル交換後、突然など
- **範囲:** 特定のホストだけ、特定の経路だけ、全体的に

---

## Step 1: 物理・リンクを確認する（L1）

**確認すること:**

- ケーブルが正しく繋がってるか（実機の場合）
- ContainerLabの場合はyamlのendpointsが正しいか
- インターフェースがupになってるか
- エラーカウンターが増え続けてないか

**判断基準:**

- インターフェースがdownなら物理問題
- エラーが多いなら品質問題（実機の場合はケーブル交換）
- ContainerLabでdownならyamlのリンク定義を見直す

---

## Step 2: 設定が正しく入ってるかを確認する（L2）

**確認すること:**

- 意図した設定がちゃんと入ってるか
- startup-configが反映されてるか
- 設定ミス（タイポ、インデント）がないか

**判断基準:**

- 設定が入ってなければ入れる
- ContainerLabの場合はredeployが必要な場合もある

---

## Step 3: IPアドレスを確認する（L3-a）

**確認すること:**

- 各インターフェースに正しいIPアドレスが入ってるか
- サブネットマスクが正しいか
- 同じセグメントのIPが重複してないか
- エンドホスト側のIPアドレスも確認する

**判断基準:**

- IPが入ってなければ設定する
- 重複してれば修正する
- サブネットが合ってなければ修正する

---

## Step 4: 隣接関係・テーブルを確認する（L3-b）

プロトコルによって確認する内容が変わる。

**OSPFの場合:**

- ネイバーが確立されてるか（FULL状態か）
- ネイバーが確立されてない場合はエリア番号、認証、MTUのミスマッチを疑う

**STPの場合:**

- ルートブリッジが意図したスイッチか
- BLKポートが意図した場所にあるか
- err-disabledになってるポートがないか

**VLANの場合:**

- 正しいVLANが正しいポートに設定されてるか
- トランクポートにVLANが許可されてるか
- PVIDが正しいか

**判断基準:**

- 隣接関係が確立されてなければそこが原因
- テーブルが正しくなければ設定を見直す

---

## Step 5: 経路・転送を確認する（L3-c）

**確認すること:**

- ルーティングテーブルに宛先ネットワークが載ってるか
- 正しい経路で転送されてるか
- エンドホストのデフォルトゲートウェイが正しいか

**判断基準:**

- 宛先が載ってなければルーティングの設定を見直す
- エンドホストのデフォルトGWが間違ってれば修正する
- ContainerLabでは管理ネットワークのデフォルトルートが自動で入るので注意

---

## Step 6: パケットレベルで確認する

Step 1〜5で原因が見つからない場合。

**確認すること:**

- パケットが実際に届いてるか（tcpdump）
- VLANタグが正しく付いてるか
- パケットがどこで止まってるか

**やり方:**

- 送信元で送信を確認
- 経路上の各ポイントで受信を確認
- 止まってるポイントがわかればそこが原因

---

## よくある原因パターン

|症状|まず疑うところ|
|---|---|
|pingが全く通らない|リンクがdown、IPアドレスのミス|
|片方向だけ通る|戻りの経路がない、デフォルトGWのミス|
|断続的に通ったり通らなかったりする|STPのループ、ルーティングが不安定|
|特定のホストだけ通らない|そのホストのIP、GW、VLANの設定|
|通信が極端に遅い|STPのループ、帯域の問題|
|設定したのに反映されない|startup-configの書き方、redeployが必要|

---

## 鉄則

1. **一度に複数箇所を変更しない。** 1箇所変えて確認してから次に進む。
2. **変更前の状態を記録する。** 何を変えたかわからなくなる。
3. **ルーター側が全部正常なのに通らない場合はエンドホストを疑う。**
4. **ContainerLabでは管理ネットワークのデフォルトルートに注意する。**
5. **症状を再現してから修正する。** 再現できない問題は直せない。