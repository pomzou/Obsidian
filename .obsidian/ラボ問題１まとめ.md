

## 今回の構成

```
host1 (192.168.10.1) ── sw2 ──── sw1 ──── sw3 ── host2 (192.168.10.2)
host3 (192.168.20.1) ──┘                   └──── host4 (192.168.20.2)
```

- VLAN10: host1, host2
- VLAN20: host3, host4
- sw1-sw2間、sw1-sw3間はトランクリンク
- sw2-host1、sw2-host3、sw3-host2、sw3-host4はアクセスリンク

---

## 基本概念

### アクセスポートとトランクポートの違い

||アクセスポート|トランクポート|
|---|---|---|
|接続先|ホスト（PC、サーバー）|スイッチ間|
|タグ|なし（ホストはVLANを意識しない）|あり（802.1Qタグ付き）|
|VLAN数|1つだけ|複数|

### 802.1QタグとはなにかLinuxブリッジで確認したこと

- ホストからのパケットはタグなしで届く
- スイッチはアクセスポートのPVIDを見て「このパケットはVLAN○○だ」と判断する
- トランクリンクを通るときは802.1Qタグが付いて転送される
- 宛先のアクセスポートから出るときにタグが剥がされてホストに届く

---

## Linuxブリッジの設定

### bridge vlan showの見方

```
port    vlan ids
e1-1     1 PVID Egress Untagged   ← VLAN1がデフォルトで入ってるだけ、気にしなくていい
         10                        ← VLAN10をtaggedで通す（トランク）
         20                        ← VLAN20をtaggedで通す（トランク）

e1-2     10 PVID Egress Untagged  ← VLAN10のアクセスポート
```

### 各設定の意味

|設定|意味|用途|
|---|---|---|
|`PVID`|タグなしで来たパケットをこのVLANとして扱う|アクセスポート必須|
|`Egress Untagged`|このポートから出るときタグを剥がす|アクセスポート必須|
|タグなし（tagged）|タグ付きのまま通す|トランクポート|

---

## 今回発生していた問題と原因

### 問題1: sw1のe1-2とsw3のe1-1にVLAN20が設定されていなかった

**症状:** VLAN20のhost3-host4間で通信できない

**原因:** トランクリンクにVLAN20が許可されていなかったのでVLAN20のパケットが転送されなかった

**修正:**

bash

```bash
bridge vlan add vid 20 dev e1-2
bridge vlan add vid 20 dev e1-1
```

---

### 問題2: アクセスポートにPVIDが設定されていなかった

**症状:** host1からhost2へpingが通らない、ARPリプライが返ってこない

**原因:**

- host1はタグなしでARPを送信する
- sw2のe1-2にPVIDがなかったのでブリッジがどのVLANか判断できなかった
- パケットがVLAN10として転送されずに止まっていた

**修正:**

bash

```bash
# sw2のe1-2 (host1向け)
bridge vlan add vid 10 dev e1-2 pvid untagged

# sw3のe1-2 (host2向け)
bridge vlan add vid 10 dev e1-2 pvid untagged
```

**重要:** 両方向に設定が必要。片方だけだと一方向にしか通信できない。

---

## トラブルシューティング手順

### 今回使ったコマンドと目的

bash

```bash
# ホスト側のインターフェース確認
ip -d link show
ip addr show e1-1

# スイッチ側のVLAN設定確認
bridge vlan show

# パケットキャプチャ（基本）
tcpdump -i e1-2

# パケットキャプチャ（MACアドレスとVLANタグも表示）
tcpdump -i e1-2 -e -n
```

### 切り分けの流れ

```
1. ホスト側のIPアドレス確認
   ↓
2. スイッチのbridge vlan showでVLAN設定を確認
   ↓
3. アクセスポート側でtcpdumpしてパケットが届いてるか確認
   ↓
4. トランクポート側でtcpdumpしてパケットが転送されてるか確認
   ↓
5. タグが付いてるかどうかを -e オプションで確認
   ↓
6. パケットが止まってるポートのbridge vlan showで原因を特定
```

### tcpdumpの出力の読み方

```
# タグなし（アクセスポートでは正常）
aa:c1:ab:be:cc:ee > ff:ff:ff:ff:ff:ff, ethertype ARP (0x0806)

# タグあり（トランクポートでは正常）
aa:c1:ab:be:cc:ee > ff:ff:ff:ff:ff:ff, ethertype 802.1Q (0x8100), vlan 10
```

---

## ポイントまとめ

- **ホストはVLANを意識しない。** タグなしでパケットを送るだけ。
- **PVIDがアクセスポートの鍵。** タグなしパケットをどのVLANとして扱うかを決める。
- **トランクはタグで識別する。** 複数VLANを1本のリンクで通せる。
- **設定は両方向に必要。** 片方だけだと一方向通信になる。
- **Cisco用語との対応:** アクセスポート = `PVID + Egress Untagged`、トランクポート = タグなし設定（taggedのまま）

---

## 次のラボ

STP / RSTP / MSTP